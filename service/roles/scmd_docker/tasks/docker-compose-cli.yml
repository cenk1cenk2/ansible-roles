- name: pull images
  shell:
    cmd: docker-compose pull
    chdir: '{{ scmd_service_dir }}'

- name: stop and remove containers
  shell:
    cmd: docker-compose down --remove-orphans && docker-compose rm -f
    chdir: '{{ scmd_service_dir }}'

- name: restart containers and scale
  shell:
    cmd: docker-compose up -d {{ '--scale ' ~ scale.key ~ '=' ~ ansible_processor_vcpus ~ ' ' if scale.value >= 1 else '' }}
    chdir: '{{ scmd_service_dir }}'
  when: scmd_scale is defined
  with_dict: '{{ scmd_scale | default({ }) }}'
  loop_control:
    loop_var: scale

- name: restart containers
  shell:
    cmd: docker-compose up -d
    chdir: '{{ scmd_service_dir }}'
  when: scmd_scale is undefined
