---
- name: include scmd_docker
  include_role:
    name: cenk1cenk2.service.scmd_docker
  vars:
    scmd_variables_only: true
    scmd_service_name: '{{ prometheus_service_name }}'

- name: create file-sd-config
  template:
    src: prometheus-file-sd-config.j2
    dest: '{{ scmd_full_volume_dir }}/{{ prometheus_container_name }}/{{ prometheus_file_sd_config_dir }}/{{ item.path }}.yml'
  vars:
    config: '{{ item.config }}'
  when:
    - item.state is not defined or item.state == "present"
  with_items: '{{ prometheus_configs }}'
  changed_when: false
  no_log: true
  async: 300
  poll: 0
  register: create_file_sd_configs_async_job

- name: remove file-sd-config
  file:
    dest: '{{ scmd_full_volume_dir }}/{{ prometheus_container_name }}/{{ prometheus_file_sd_config_dir }}/{{ item.path }}.yml'
    state: absent
  when:
    - item.state is defined
    - item.state == "absent"
  with_items: '{{ prometheus_configs }}'
  changed_when: false
  no_log: true
  async: 300
  poll: 0
  register: remove_file_sd_configs_async_job

- name: wait for job to end
  ansible.builtin.async_status:
    jid: '{{ item.ansible_job_id }}'
    mode: status
  register: async_result
  until: async_result.finished
  retries: 100
  delay: 2
  with_items:
    - '{{ create_file_sd_configs_async_job.results | default([]) }}'
    - '{{ remove_file_sd_configs_async_job.results | default([]) }}'
