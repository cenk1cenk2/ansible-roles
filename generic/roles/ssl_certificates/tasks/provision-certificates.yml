- name: include scmd role
  include_role:
    name: cenk1cenk2.service.scmd_docker
    public: true
  vars:
    scmd_variables_only: true
    scmd_service_name: any

- name: include nginx role
  include_role:
    name: cenk1cenk2.service.nginx_vhosts
    public: true
  vars:
    vhost_variables_only: true

- name: set ssl certificates available
  set_fact:
    ssl_certificates: '{{ ssl_certificates | default([]) + [ { "path": cert.path, "root": cert.root + "/" + cert.path } ] }}'
  when:
    - cert.state == 'file'
    - cert.path is match("(" + ssl_certificate_domains | join("|") + ")/(fullchain|privkey).pem.secrets.j2") or cert.path is match("(" + ssl_certificate_domains | join("|") + ")/(cert).pfx.secrets.j2")
  with_filetree: '{{ ssl_certificates_root }}'
  loop_control:
    loop_var: cert

- name: ensure certificate directories
  file:
    path: '{{ letsencrypt_cert_dir }}/live/{{ cert.path | dirname }}'
    state: directory
  with_items:
    - '{{ ssl_certificates }}'
  loop_control:
    loop_var: cert
  when:
    - ssl_certificates is defined

- name: copy ssl certificates
  template:
    src: '{{ cert.root }}'
    dest: "{{ letsencrypt_cert_dir }}/live/{{ cert.path | regex_replace('.secrets.j2$', '') }}"
  with_items:
    - '{{ ssl_certificates }}'
  loop_control:
    loop_var: cert
  when:
    - ssl_certificates is defined
